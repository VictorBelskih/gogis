{{ template "header.html" . }}


            <div class="col py-3 content">
                <div class="row">
                    <div class="col-md-4 shadow-lg block ">
                        <h1>Информация о хозяйстве</h1>
                        <p><a href="/report">Отчет</a></p>
                        <div class="inf">
                            {{with index .FieldData 0}}
                            <h3>{{.Reg_name}}</h3>
                            {{end}}
                            <p>
                                
                                Общая площадь: {{.totalArea}}<br>
                                {{range $key, $value := .totalAreaByFieldType}}
                                    {{if eq $key "пашня"}}
                                        <p class="area"><b>пашня:</b></p><p> {{$value}} Га</p>
                                    {{end}}
                                    {{if eq $key "сенокос"}}
                                        <p class="area"><b>сенокос:</b></p><p> {{$value}} Га</p>
                                    {{end}}
                                {{end}}
                                
                                
                            </p>
                            <table class="table table-dark">

                                <tr>
                                    <td class="table-primary">Тип</td>
                                    <td class="table-primary">Подтип</td>
                                    <td class="table-primary">Мех.Состав</td>
                                    <td class="table-primary">Площадь</td>
                                </tr>
                                {{range .SoilData}}
                                <tr>
                                    <td>{{.Type}}</td>
                                    <td>{{.SubType}}</td>
                                    <td>{{.MechComp}}</td>
                                    <td>{{printf "%.1f" .Area}}</td>
                                </tr>
                                {{end}}
                            </table> 
                        </div>
                        
                            
                    </div>
                    <div class="col-md-2 shadow-lg block" id="otchet">
                        <div class="chart"><canvas id="myChart"></canvas></div>
                        <div class="chart"><canvas id="soilChart"></canvas></div> 
                                              
                    </div>
                    <div class="col-md-5 shadow-lg block">
                        <div class="chart1"><canvas id="myPieChart"></canvas></div>
                        
                            <table class="table table-dark">

                                <tr>
                                    <td class="table-primary">Класс</td>
                                    <td class="table-primary">Площадь</td>
                                    <td class="table-primary">%</td>
                                </tr>
                                {{range .AvgOrganic}}
                                <tr>
                                    <td>{{.Class}}</td>
                                    <td>{{printf "%.1f" .TotalArea}}</td>
                                    <td>{{printf "%.1f" .Percentage}}</td>
                                </tr>
                                {{end}}
                            </table>                     
                    </div>

                <div class="row">
                    <div class="col-md-3 shadow-lg block" id="otchet">
                        
                        <h1>Загрязнения</h1>
                        
                        <table class="table">
                            <tbody>
                                <tr>
                                    <td>Среднее содержание цезия:</td>
                                    <td>{{printf "%.4f" .avgRad.AverageCesium}} Бк/кг</td>
                                </tr>
                                <tr>
                                    <td>Среднее содержание стронция:</td>
                                    <td>{{printf "%.4f" .avgRad.AverageStrontium}} Бк/кг</td>
                                </tr>
                                <tr>
                                    <td>Максимальное содержание цезия:</td>
                                    <td>{{printf "%.4f" .avgRad.MaxCesium}} Бк/кг</td>
                                </tr>
                                <tr>
                                    <td>Максимальное содержание стронция:</td>
                                    <td>{{printf "%.4f" .avgRad.MaxStrontium}} Бк/кг</td>
                                </tr>
                                <tr>
                                    <td>Средняя плотность<br> загрязнения цезием:</td>
                                    <td>{{printf "%.4f" .avgRad.AvgDensityCs137}} Ku/кв. км </td>
                                </tr>
                                <tr>
                                    <td>Средняя плотность<br> загрязнения стронцием:</td>
                                    <td>{{printf "%.4f" .avgRad.AvgDensitySr90}} Ku/кв. км</td>
                                </tr>
                                <tr>
                                    <td>Максимальная плотность<br> загрязнения цезием:</td>
                                    <td>{{printf "%.4f" .avgRad.MaxDensityCs137}} Ku/кв. км</td>
                                </tr>
                                <tr>
                                    <td>Максимальная плотность<br> загрязнения стронцием:</td>
                                    <td>{{printf "%.4f" .avgRad.MaxDensitySr90}} Ku/кв. км</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-4 shadow-lg block">
                        <div class="chart1"><canvas id="avgK"></canvas></div>
                        <table class="table table-dark">

                            <tr>
                                <td class="table-primary">Класс</td>
                                <td class="table-primary">Площадь</td>
                                <td class="table-primary">%</td>
                            </tr>
                            {{range .AvgK}}
                            <tr>
                                <td>{{.Class}}</td>
                                <td>{{printf "%.1f" .TotalArea}}</td>
                                <td>{{printf "%.1f" .Percentage}}</td>
                            </tr>
                            {{end}}
                        </table>     
                    </div>   
                    <div class="col-md-4 shadow-lg block">
                        <div class="chart1"><canvas id="avgP"></canvas></div>
                        <table class="table table-dark">

                            <tr>
                                <td class="table-primary">Класс</td>
                                <td class="table-primary">Площадь</td>
                                <td class="table-primary">%</td>
                            </tr>
                            {{range .AvgP}}
                            <tr>
                                <td>{{.Class}}</td>
                                <td>{{printf "%.1f" .TotalArea}}</td>
                                <td>{{printf "%.1f" .Percentage}}</td>
                            </tr>
                            {{end}}
                        </table>    
                    </div> 
                        
                        
                        
                        
                        
                </div>
                </div>
                <div class="row maper">                 
                    <div id="map" class="col-md-8 map">
                    <div class="selectbox">
                    <select id="selectbox" class="form-select form-select-lg mb-3">
                        <option value="poly" selected>Полигоны</option>
                        <option value="tlu">Вид угодия</option>                      
                        <option value="humus">Содержание гумуса</option>
                        <option value="k">Содержание калия</option>
                        <option value="p">Содержание фосфора</option>
                    </select>
                    </div>
                    <div id="panel" class="panel">
                        <span id="closeBtn">&times;</span>
                        <div id="infoContent"></div>                                                       
                    </div>
                    <div id="legend-g" class="legend"><img src="/static/img/legend-g.JPG" alt="" class="leg"></div>
                    <div id="legend-k" class="legend"><img src="/static/img/legend-k.JPG" alt="" class="leg"></div>
                    <div id="legend-p" class="legend"><img src="/static/img/legend-p.JPG" alt="" class="leg"></div>   
                </div>
                    
                                
                </div>
            </div>
        </div>
    </div>


  
<script>


var map = L.map('map').setView([53.7215862, 91.4612620], 13);
    
var googleLayer = L.tileLayer('http://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    maxZoom: 18
});
    
    
var openStreetMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
    maxZoom: 18
});

    geojson = {{.userField}}; // замените на вашу переменную userField




var colorMap = {
    tlu: {
        102: 'red',
        200: 'blue',
        300: 'green',
        500: 'yellow'
    },
    humus: {
        "Очень низкое": 'red',
        "Низкое": 'orange',
        "Среднее": 'yellow',
        "Повышенное": 'green',
        "Высокое": 'blue',
        "Очень Высокое": '#002F55'
    },
    k: {
        "Очень низкая": 'red',
        "Низкая": 'orange',
        "Средняя": 'yellow',
        "Повышенная": 'green',
        "Высокая": 'blue',
        "Очень Высокая": '#002F55' 
    }
};
var styleOptions = {
    fillColor: 'grey',
    fillOpacity: 0.7,
    color: 'black',
    weight: 1
};
document.getElementById('selectbox').addEventListener('change', function() {
var selectedValue = document.getElementById('selectbox').value;

geojsonLayer.eachLayer(function(layer) {
        var color;
        var legend_g = document.getElementById('legend-g');
        var legend_k = document.getElementById('legend-k');
        var legend_p = document.getElementById('legend-p');
        var HumusClass = layer.feature.properties.Humus_class;
        var tluValue = layer.feature.properties.Tlu;
        var k = layer.feature.properties.Class_k;
        var p = layer.feature.properties.Class_p;
        switch (selectedValue) {
            case 'tlu':
                color = colorMap.tlu[tluValue] || 'gray';
                legend_g.style.display='none';
                legend_k.style.display='none';
                legend_p.style.display='none';
                break;
            case 'humus':
                color = colorMap.humus[HumusClass] || '#3f00ff';
                legend_g.style.display='block';
                legend_k.style.display='none';
                legend_p.style.display='none';
                break;
            case 'k':
                color = colorMap.k[k] || '#3f00ff';
                legend_g.style.display='none';
                legend_k.style.display='block';
                legend_p.style.display='none';
                break; 
            case 'p':
                color = colorMap.k[p] || '#3f00ff';
                legend_g.style.display='none';
                legend_k.style.display='none';
                legend_p.style.display='block';
            break;    
            case 'poly':
                color = 'gray';
                legend_g.style.display='none'
                legend_k.style.display='none'
                legend_p.style.display='none'
        }

        layer.setStyle({
            fillColor: color,
            fillOpacity: 0.5,
            color: 'black',
            weight: 1
        });
    });
});



var info = document.getElementById('panel');
document.getElementById('selectbox').dispatchEvent(new Event('change'));

var infoContent = document.getElementById('infoContent');

closeBtn.addEventListener('click', function() {
    hideInfo();
});

function hideInfo() {
    info.style.display = 'none';
}

function showInfo(content) {
    info.style.display = 'block';
    infoContent.innerHTML = content;
}

var geojsonLayer = L.geoJSON(geojson, {
    style: function(feature) {
        return styleOptions;
    },
    onEachFeature: function(feature, layer) {
        // layer.bindPopup('Номер хозяйства: ' + feature.properties.Farm_name + '<br>Номер поля: ' + feature.properties.Id_eu +
        //     '<br>TLU: ' + feature.properties.Tlu_name + '<br>Площадь: ' + feature.properties.Area_f +
        //     '<br>Гумус: ' + feature.properties.Organic + '<br>Фосфор: ' + feature.properties.El_p + '<br>Класс содержания Фосфора: ' + feature.properties.Class_p +
        //     '<br>Калий: ' + feature.properties.El_k + '<br>Класс содержания Калия: ' + feature.properties.Class_k + '<br>Класс содержания гумуса: ' + feature.properties.Humus_class
        //     +'<br>pH h20: ' + feature.properties.ph_water
        // );
        
        var selectedPolygon = null;
        var originalStyle = null;
        layer.on('click', function(e) {
            if (e.target.options.weight === 2) {               
                e.target.setStyle({ weight: 1, color: 'black' });
            } else {
                geojsonLayer.eachLayer(function(layer) {
                    if (layer.options.weight === 2) {
                        layer.setStyle({ weight: 1, color: 'black' });
                    }
                });
                e.target.setStyle({ weight: 2, color: 'red' });
            }
            var id_g = feature.properties.Id_eu;
            console.log('ID value:', id_g);
            e.target.feature;      
            var infoContentHTML = 
                      '<button class="form-control success" id="download-button">Скачать как Word</button>'+  
                      '<table class="table table-dark" id="otch">' + 
                      '<tr><td class="table-primary" colspan="2"><h3>Паспорт поля</h3></td></tr>' +    
                      '<tr><td>Номер хозяйства:</td><td>' + feature.properties.Farm_name + '</td></tr>' +                    
                      '<tr><td>Номер поля:</td><td>' + feature.properties.Id_eu + '</td></tr>' +
                      '<tr><td>TLU:</td><td>' + feature.properties.Tlu_name + '</td></tr>' +
                      '<tr><td>Факт использования:</td><td>' + feature.properties.fact_isp + '</td></tr>' +
                      '<tr><td>Дата обследования:</td><td>' + feature.properties.Date + '</td></tr>' +
                      '<tr><td>Площадь:</td><td>' + feature.properties.Area_f + '</td></tr>' +
                      '<tr><td>Культура:</td><td>' + feature.properties.Title + '</td></tr>' +
                      '<tr><td>Культура предудущая:</td><td>' + feature.properties.Title2 + '</td></tr>' +
                      '<tr><td>Тип почв:</td><td>' + feature.properties.T_pojv + '</td></tr>' +
                      '<tr><td>Подтип почв:</td><td>' + feature.properties.Sub_pojv + '</td></tr>' +
                      '<tr><td>Мех состав:</td><td>' + feature.properties.Mex_sost + '</td></tr>' +
                      '<tr><td>Индекс почв:</td><td>' + feature.properties.S_ind + '</td></tr>' +
                      '<tr><td class="table-primary" colspan="2"><b>Показатели гумуса:</b></td></tr>' +
                      '<tr><td>Гумус:</td><td>' + feature.properties.Organic + '</td></tr>' +
                      '<tr><td>Класс содержания гумуса:</td><td>' + feature.properties.Humus_class + '</td></tr>' +
                      '<tr><td>pH h20:</td><td>' + feature.properties.ph_water + '</td></tr>' +
                      '<tr><td class="table-primary" colspan="2"><b>Показатели фосфора:</b></td></tr>' +
                      '<tr><td>Фосфор:</td><td>' + feature.properties.El_p + '</td></tr>' +
                      '<tr><td>Класс содержания Фосфора:</td><td>' + feature.properties.Class_p + '</td></tr>' +
                      '<tr><td>Калий:</td><td>' + feature.properties.El_k + '</td></tr>' +
                      '<tr><td>Класс содержания Калия:</td><td>' + feature.properties.Class_k + '</td></tr>' + 
                      '<tr><td class="table-primary" colspan="2"><b>Тяжелые металлы:</b></td></tr>' +
                      '<tr><td>Zn(Цинк):</td><td>' + feature.properties.El_zn +'</td></tr>' +
                      '<tr><td>Cu(Медь):</td><td>' + feature.properties.El_cu +'</td></tr>' + 
                      '<tr><td>Mn(Марганец):</td><td>' + feature.properties.El_mn +'</td></tr>' + 
                      '<tr><td>Co(Кобальт):</td><td>' + feature.properties.El_co +'</td></tr>' +
                      '<tr><td>Pb(Свинец):</td><td>' + feature.properties.Met_pb +'</td></tr>' +
                      '<tr><td>Сd(Кадмий):</td><td>' + feature.properties.Met_cd +'</td></tr>' +                     
                      '<tr><td>Hg(Ртуть):</td><td>' + feature.properties.Met_hg +'</td></tr>' +
                      '<tr><td>S(Сера):</td><td>' + feature.properties.El_s +'</td></tr>'+
                      '<tr><td>B(Бор):</td><td>' + feature.properties.El_b +'</td></tr>'+ 
                      '<tr><td>As(Мышьяк):</td><td>' + feature.properties.Met_as +'</td></tr>'+ 
                      '<tr><td class="table-primary" colspan="2"><b>Прочая информация о поле</b></td></tr>' +
                      '<tr><td>Ил:</td><td>' + feature.properties.Il +'</td></tr>'+ 
                      '<tr><td>Глина:</td><td>' + feature.properties.Glina +'</td></tr>'+ 
                      '<tr><td>Торф:</td><td>' + feature.properties.F_torf +'</td></tr>'+ 
                      '<tr><td>Переувлажнение:</td><td>' + feature.properties.Pereyv +'</td></tr>'+ 
                      '<tr><td>Плотность:</td><td>' + feature.properties.Plotn +'</td></tr>'+ 
                      '<tr><td>Агрегированность:</td><td>' + feature.properties.Agreg +'</td></tr>'+ 
                      '<tr><td>Полевая влагоемкость:</td><td>' + feature.properties.Field_vl  +'</td></tr>'+
                      '<tr><td>Степень насыщения основаниями:</td><td>' + feature.properties.Nas_osn  +'</td></tr>'+ 
                      '<tr><td>Степень каменистости:</td><td>' + feature.properties.Kamn +'</td></tr>'+ 
                      '<tr><td>Уклоны поверхности:</td><td>' + feature.properties.Yklon +'</td></tr>'+ 
                      '<tr><td class="table-primary" colspan="2"><b>Загрязнения</b></td></tr>' +
                      '<tr><td>Загрязнение тяжелыми металлами:</td><td>' + feature.properties.Zagryaz +'</td></tr>'+ 
                      '<tr><td>Содержание остаточных пестицидов:</td><td>' + feature.properties.Plt_tox +'</td></tr>'+ 
                      '<tr><td>Содержание нефтепродуктов:</td><td>' + feature.properties.Plt_oil +'</td></tr>'+ 
                      '<tr><td>Цезий-137:</td><td>' + feature.properties.Cs137 +'</td></tr>'+ 
                      '<tr><td>Стронций-90:</td><td>' + feature.properties.Sr90  +'</td></tr>'+ 
                      '<tr><td>Мощность экспозиционной дозы (гамма-фон)</td><td>' + feature.properties.Gamma  +'</td></tr>'+ 
                      '<tr><td class="table-primary" colspan="2"><b>Засоление</b></td></tr>' +
                      '<tr><td>Засоление почв (содержание водорастворимых/токсичных солей):</td><td>' + feature.properties.Salinity  +'</td></tr>'+ 
                      '<tr><td class="table-primary" colspan="2"><b>Солонцеватость почв</b></td></tr>' +
                      '<tr><td>по содержанию обменного Na:</td><td>' + feature.properties.Solon_na +'</td></tr>'+ 
                      '<tr><td>Доля солонцов и солонцеватых почв:</td><td>' + feature.properties.Solon_pr +'</td></tr>'+ 
                      '<tr><td class="table-primary" colspan="2"><b>Почвы подверженные</b></td></tr>' +
                      '<tr><td>Ветровой эрозии:</td><td>' + feature.properties.Wind_er +'</td></tr>'+ 
                      '<tr><td>Водной эрозии:</td><td>' + feature.properties.Water_er  +'</td></tr>'+ 
                      '<tr><td>Закустаренность:</td><td>' + feature.properties.Kust+'</td></tr>'+ 
                      '<tr><td>Залесенность:</td><td>' + feature.properties.Les  +'</td></tr>'+ 
                      '<tr><td>Степень зарастания:</td><td>' + feature.properties.Sorn +'</td></tr>'+ 
                      '<tr><td>Застроеннные участки</td><td>' + feature.properties.Stroy +'</td></tr>'+ 
                      '<tr><td>Нарушение земельного участка</td><td>' + feature.properties.F_narsh+'</td></tr>'+ 
                      '<tr><td>Прочее</td><td>' + feature.properties.Prch+'</td></tr>'+
                      '<tr><td class="table-primary" colspan="2"><b>Мощность</b></td></tr>' +
                      '<tr><td>Мощность гумуса:</td><td>' + feature.properties.Mosh_g+'</td></tr>'+ 
                      '<tr><td>Мощность мелкозема:</td><td>' + feature.properties.Mosh_m  +'</td></tr>'+ 
                      '<tr><td>Биологическая активность почвы (определение микробиологической активности):</td><td>' + feature.properties.Microbio +'</td></tr>'+ 
                      '<tr><td class="table-primary" colspan="2"><b>Содержание радионуклидов</b></td></tr>' +
                      '<tr><td>(Цезий-137)</td><td>' + feature.properties.S_cs137 +'</td></tr>'+ 
                      '<tr><td>(Стронций-90)</td><td>' + feature.properties.S_sr90+'</td></tr>'+ 
                      '<tr><td>Доля засолённых почв</td><td>' + feature.properties.Solon_d+'</td></tr>'+                    
                      '</table>'; 

            showInfo(infoContentHTML);
            // Добавьте обработчик событий для кнопки
        document.getElementById('download-button').addEventListener('click', function() {
            // Получите HTML-элемент, который вы хотите перенести в Word
            var element = document.getElementById('otch');
            var html = element.outerHTML;
            
            // Преобразуйте HTML в Blob
            var docx = htmlDocx.asBlob(html);
            
            // Сохраните Blob как файл Word на устройстве
            saveAs(docx, 'document.docx');
        });
            
        });
    }
}).addTo(map);
    
var overlayMaps = {
    "GeoJSON": geojsonLayer,
    "Google": googleLayer,
    "OpenStreetMap": openStreetMapLayer,
};
            
L.control.layers(null, overlayMaps, { collapsed: true }).addTo(map);
    map.addLayer(googleLayer);
    
// map.on('click', function(e) {
//     geojsonLayer.eachLayer(function(layer) {
//         if (layer.options.weight === 2 && layer.options.color === 'red') {
//             layer.setStyle({ weight: 1, color: 'black' });
//         }
//     });
            
// });
            
var elements = document.getElementsByClassName('leaflet-attribution-flag');
    Array.from(elements).forEach(function(element) {
        element.style.height = '0px';
        element.style.width = '0px';
    });
        
</script>



<script src="/static/chart.js"></script>

<script>
    var totalAreaByFieldType = {{.totalAreaByFieldType}};
    createChart(totalAreaByFieldType);
    var avgOrganic = {{.AvgOrganic}};
    console.log(avgOrganic)
    avgOrganicStackedChart(avgOrganic);
    var avgK = {{.AvgK}};
    var avgP = {{.AvgP}}; 
    avgKStackedChart(avgK);
    avgPStackedChart(avgP);
    var soilData = {{.SoilData}}
    createPieChart(soilData) 
</script>
  
</body>
</html>